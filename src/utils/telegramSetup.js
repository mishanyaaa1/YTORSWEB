// –£—Ç–∏–ª–∏—Ç—ã –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Telegram –±–æ—Ç–∞

import { getBotInfo, getUpdates } from './telegramService';

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ –±–æ—Ç–∞
export const checkBotStatus = async () => {
  console.log('ü§ñ –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å Telegram –±–æ—Ç–∞...');
  
  const botInfo = await getBotInfo();
  if (botInfo && botInfo.ok) {
    console.log('‚úÖ –ë–æ—Ç —É—Å–ø–µ—à–Ω–æ –ø–æ–¥–∫–ª—é—á–µ–Ω!');
    console.log('üìã –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±–æ—Ç–µ:', {
      id: botInfo.result.id,
      username: botInfo.result.username,
      first_name: botInfo.result.first_name
    });
    return true;
  } else {
    console.error('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–æ—Ç—É');
    return false;
  }
};

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è chat_id
export const getChatId = async () => {
  console.log('üîç –ü–æ–ª—É—á–∞–µ–º chat_id...');
  
  const updates = await getUpdates();
  if (updates && updates.ok && updates.result.length > 0) {
    const chatIds = new Set();
    
    updates.result.forEach(update => {
      const chatId = update.message?.chat?.id || update.channel_post?.chat?.id;
      if (chatId) {
        chatIds.add(chatId);
      }
    });
    
    if (chatIds.size > 0) {
      console.log('‚úÖ –ù–∞–π–¥–µ–Ω—ã chat_id:', Array.from(chatIds));
      return Array.from(chatIds);
    }
  }
  
  console.log('‚ö†Ô∏è Chat_id –Ω–µ –Ω–∞–π–¥–µ–Ω. –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ:');
  console.log('1. –í—ã –æ—Ç–ø—Ä–∞–≤–∏–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –±–æ—Ç—É');
  console.log('2. –ë–æ—Ç –¥–æ–±–∞–≤–ª–µ–Ω –≤ –≥—Ä—É–ø–ø—É/–∫–∞–Ω–∞–ª');
  return [];
};

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è
export const testTelegramNotification = async () => {
  try {
    console.log('üß™ –¢–µ—Å—Ç–∏—Ä—É–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è...');
    
    const testMessage = `
üß™ <b>–¢–ï–°–¢–û–í–û–ï –°–û–û–ë–©–ï–ù–ò–ï</b>

–≠—Ç–æ —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å Telegram.

‚úÖ –ï—Å–ª–∏ –≤—ã –ø–æ–ª—É—á–∏–ª–∏ —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ, —Ç–æ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ!

üïí –í—Ä–µ–º—è –æ—Ç–ø—Ä–∞–≤–∫–∏: ${new Date().toLocaleString('ru-RU')}
`;
    
    const { sendTelegramMessage } = await import('./telegramService');
    const result = await sendTelegramMessage(testMessage);
    
    if (result.success) {
      console.log('‚úÖ –¢–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!');
      return true;
    } else {
      console.error('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è:', result.error);
      return false;
    }
  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏:', error);
    return false;
  }
};

// –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ –±–æ—Ç–∞
export const showSetupInstructions = () => {
  console.log(`
ü§ñ –ò–ù–°–¢–†–£–ö–¶–ò–Ø –ü–û –ù–ê–°–¢–†–û–ô–ö–ï TELEGRAM –ë–û–¢–ê

1. –°–æ–∑–¥–∞–π—Ç–µ –±–æ—Ç–∞ —á–µ—Ä–µ–∑ @BotFather –≤ Telegram:
   - –û—Ç–ø—Ä–∞–≤—å—Ç–µ –∫–æ–º–∞–Ω–¥—É /newbot
   - –ü—Ä–∏–¥—É–º–∞–π—Ç–µ –∏–º—è –∏ username –¥–ª—è –±–æ—Ç–∞
   - –ü–æ–ª—É—á–∏—Ç–µ —Ç–æ–∫–µ–Ω –±–æ—Ç–∞

2. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–æ–ª—É—á–µ–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π:
   
   –í–∞—Ä–∏–∞–Ω—Ç –ê - –õ–∏—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è:
   - –ù–∞–π–¥–∏—Ç–µ –≤–∞—à–µ–≥–æ –±–æ—Ç–∞ –≤ Telegram
   - –û—Ç–ø—Ä–∞–≤—å—Ç–µ –µ–º—É –ª—é–±–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä "/start")
   
   –í–∞—Ä–∏–∞–Ω—Ç –ë - –ì—Ä—É–ø–ø–∞/–∫–∞–Ω–∞–ª:
   - –°–æ–∑–¥–∞–π—Ç–µ –≥—Ä—É–ø–ø—É –∏–ª–∏ –∫–∞–Ω–∞–ª
   - –î–æ–±–∞–≤—å—Ç–µ –±–æ—Ç–∞ –∫–∞–∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
   - –û—Ç–ø—Ä–∞–≤—å—Ç–µ –ª—é–±–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –≥—Ä—É–ø–ø—É/–∫–∞–Ω–∞–ª

3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:
   - –û—Ç–∫—Ä–æ–π—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ (F12)
   - –í—ã–ø–æ–ª–Ω–∏—Ç–µ: window.telegramSetup.checkBotStatus()
   - –í—ã–ø–æ–ª–Ω–∏—Ç–µ: window.telegramSetup.getChatId()
   - –í—ã–ø–æ–ª–Ω–∏—Ç–µ: window.telegramSetup.testTelegramNotification()

4. –¢–æ–∫–µ–Ω –±–æ—Ç–∞ —É–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –≤ —Å–∏—Å—Ç–µ–º–µ: 8220911923:AAHOV3xvBPioSoBh53bPfceJBBkFYk1aqu0

‚ùó –í–ê–ñ–ù–û: –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –±–æ—Ç –∏–º–µ–µ—Ç –ø—Ä–∞–≤–∞ –Ω–∞ –æ—Ç–ø—Ä–∞–≤–∫—É —Å–æ–æ–±—â–µ–Ω–∏–π!
`);
};

// –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º –≤ –≥–ª–æ–±–∞–ª—å–Ω—É—é –æ–±–ª–∞—Å—Ç—å –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏–∑ –∫–æ–Ω—Å–æ–ª–∏
if (typeof window !== 'undefined') {
  window.telegramSetup = {
    checkBotStatus,
    getChatId, 
    testTelegramNotification,
    showSetupInstructions
  };
}

export default {
  checkBotStatus,
  getChatId,
  testTelegramNotification,
  showSetupInstructions
};
