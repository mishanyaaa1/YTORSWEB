<!-- Performance Optimizations for Core Web Vitals -->

<!-- Preload critical fonts -->
<link rel="preload" href="https://fonts.googleapis.com/css2?family=Russo+One&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Russo+One&display=swap"></noscript>

<!-- Preload critical images -->
<link rel="preload" href="/src/img/лого вектор 2-min.png" as="image" type="image/png">

<!-- Resource Hints -->
<link rel="dns-prefetch" href="//www.google-analytics.com">
<link rel="dns-prefetch" href="//mc.yandex.ru">
<link rel="dns-prefetch" href="//connect.facebook.net">
<link rel="dns-prefetch" href="//vk.com">

<!-- Performance Monitoring Script -->
<script>
// Core Web Vitals monitoring
if ('PerformanceObserver' in window) {
  // LCP (Largest Contentful Paint)
  const lcpObserver = new PerformanceObserver((list) => {
    const entries = list.getEntries();
    const lastEntry = entries[entries.length - 1];
    console.log('LCP:', lastEntry.startTime);
    
    // Send to analytics if LCP is poor
    if (lastEntry.startTime > 2500) {
      console.warn('Poor LCP detected:', lastEntry.startTime);
    }
  });
  lcpObserver.observe({ entryTypes: ['largest-contentful-paint'] });

  // FID (First Input Delay)
  const fidObserver = new PerformanceObserver((list) => {
    const entries = list.getEntries();
    entries.forEach(entry => {
      console.log('FID:', entry.processingStart - entry.startTime);
      
      // Send to analytics if FID is poor
      if (entry.processingStart - entry.startTime > 100) {
        console.warn('Poor FID detected:', entry.processingStart - entry.startTime);
      }
    });
  });
  fidObserver.observe({ entryTypes: ['first-input'] });

  // CLS (Cumulative Layout Shift)
  let clsValue = 0;
  const clsObserver = new PerformanceObserver((list) => {
    for (const entry of list.getEntries()) {
      if (!entry.hadRecentInput) {
        clsValue += entry.value;
        console.log('CLS:', clsValue);
        
        // Send to analytics if CLS is poor
        if (clsValue > 0.1) {
          console.warn('Poor CLS detected:', clsValue);
        }
      }
    }
  });
  clsObserver.observe({ entryTypes: ['layout-shift'] });
}

// Performance timing
window.addEventListener('load', () => {
  setTimeout(() => {
    const perfData = performance.getEntriesByType('navigation')[0];
    if (perfData) {
      const metrics = {
        dns: perfData.domainLookupEnd - perfData.domainLookupStart,
        tcp: perfData.connectEnd - perfData.connectStart,
        ttfb: perfData.responseStart - perfData.requestStart,
        domLoad: perfData.domContentLoadedEventEnd - perfData.domContentLoadedEventStart,
        windowLoad: perfData.loadEventEnd - perfData.loadEventStart,
        total: perfData.loadEventEnd - perfData.fetchStart
      };
      
      console.log('Performance Metrics:', metrics);
      
      // Send to analytics
      if (typeof gtag !== 'undefined') {
        gtag('event', 'performance_metrics', {
          event_category: 'Performance',
          event_label: 'Page Load',
          value: Math.round(metrics.total),
          custom_parameter_1: metrics.ttfb,
          custom_parameter_2: metrics.domLoad,
          custom_parameter_3: '+7 (351) 21-444-32',
          custom_parameter_4: 'info@ytors.ru',
          custom_parameter_5: 'Челябинск'
        });
      }
    }
  }, 0);
});

// Intersection Observer for lazy loading
if ('IntersectionObserver' in window) {
  const imageObserver = new IntersectionObserver((entries, observer) => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        const img = entry.target;
        img.src = img.dataset.src;
        img.classList.remove('lazy');
        observer.unobserve(img);
      }
    });
  });

  // Observe all lazy images
  document.querySelectorAll('img[data-src]').forEach(img => {
    imageObserver.observe(img);
  });
}

// Service Worker for caching
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/sw.js')
      .then(registration => {
        console.log('SW registered: ', registration);
      })
      .catch(registrationError => {
        console.log('SW registration failed: ', registrationError);
      });
  });
}

// Critical CSS inline
const criticalCSS = `
  body { font-family: 'Russo One', sans-serif; }
  .loading { display: flex; justify-content: center; align-items: center; height: 100vh; }
  .critical-content { opacity: 1; transition: opacity 0.3s; }
  .contact-info { 
    background: #f5f5f5; 
    padding: 1rem; 
    border-radius: 8px; 
    margin: 1rem 0; 
  }
  .contact-info .phone { 
    color: #007bff; 
    font-weight: bold; 
    font-size: 1.2rem; 
  }
  .contact-info .email { 
    color: #28a745; 
    font-weight: bold; 
  }
  .contact-info .city { 
    color: #6c757d; 
    font-style: italic; 
  }
`;

const style = document.createElement('style');
style.textContent = criticalCSS;
document.head.appendChild(style);

// Add contact information to page
document.addEventListener('DOMContentLoaded', () => {
  const contactInfo = document.createElement('div');
  contactInfo.className = 'contact-info';
  contactInfo.innerHTML = `
    <div><span class="phone">Телефон: +7 (351) 21-444-32</span></div>
    <div><span class="email">Email: info@ytors.ru</span></div>
    <div><span class="city">Город: Челябинск</span></div>
  `;
  
  // Insert at the beginning of body
  if (document.body) {
    document.body.insertBefore(contactInfo, document.body.firstChild);
  }
});
</script>

<!-- Preload critical resources -->
<link rel="modulepreload" href="/src/main.jsx">
<link rel="modulepreload" href="/src/App.jsx">
<link rel="modulepreload" href="/src/index.jsx">

<!-- Prefetch non-critical resources -->
<link rel="prefetch" href="/src/pages/CatalogPage.jsx">
<link rel="prefetch" href="/src/pages/About.jsx">
<link rel="prefetch" href="/src/pages/Cart.jsx">

<!-- Compression hints -->
<meta http-equiv="Accept-Encoding" content="gzip, deflate, br">
